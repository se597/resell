<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>회원가입</title>
<link rel="stylesheet" th:href="@{/css/join.css}">
<link rel="stylesheet" th:href="@{/css/header.css}">

<!-- 🧩 카카오(다음) 우편번호 API 불러오기 -->
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
let idChecked = false;

// 🔹 아이디 중복체크
function dupl_check() {
  const idInput = document.querySelector("input[name='id']");
  const idValue = idInput.value.trim();

  if (!idValue) {
    alert("아이디를 입력하세요.");
    idChecked = false;
    return;
  }

  fetch(`/dupl_check?id=${encodeURIComponent(idValue)}`)
    .then(response => response.text())
    .then(result => {
      if (result === "true") {
        alert("사용 가능한 아이디입니다.");
        idChecked = true;
      } else {
        alert("이미 존재하는 아이디입니다.");
        idChecked = false;
      }
    })
    .catch(err => {
      alert("서버 오류가 발생했습니다.");
      console.error(err);
      idChecked = false;
    });
}

function idChanged() {
  idChecked = false;
}

// 🔹 회원가입 폼 제출 전 검사
function checkFormSubmit(event) {
  if (!idChecked) {
    alert("중복체크를 하고 사용 가능한 아이디를 입력하세요!");
    event.preventDefault();
    return;
  }

  const requiredFields = ["id", "pw", "nickname", "name", "zipcode", "address", "birth", "phone_number", "email"];
  for (let fieldName of requiredFields) {
    const field = document.querySelector(`input[name='${fieldName}']`);
    if (!field || !field.value.trim()) {
      alert(`${fieldName}를 입력하세요.`);
      field.focus();
      event.preventDefault();
      return;
    }
  }
}

// 🔹 카카오 주소 API
function findPostcode() {
  new daum.Postcode({
    oncomplete: function(data) {
      document.getElementById('zipcode').value = data.zonecode; // 우편번호
      document.getElementById('address').value = data.address;   // 기본 주소
      document.getElementById('address_detail').focus();         // 상세주소로 포커스 이동
    }
  }).open();
}
</script>
</head>

<body>
<div th:replace="layout/header :: siteHeader"></div>

<div class="page-content">
  <h2>회원가입</h2>

  <form action="/join" method="post" onsubmit="checkFormSubmit(event)">
    <table>
      <tr>
        <td>아이디</td>
        <td>
          <input type="text" name="id" oninput="idChanged()">
        </td>
        <td>
          <button type="button" onclick="dupl_check()">중복체크</button>
        </td>
      </tr>
      <tr><td>비밀번호</td><td colspan="2"><input type="password" name="pw"></td></tr>
      <tr><td>닉네임</td><td colspan="2"><input type="text" name="nickname"></td></tr>
      <tr><td>이름</td><td colspan="2"><input type="text" name="name"></td></tr>
      <tr>
        <td>주소</td>
        <td colspan="2">
          <input type="text" id="zipcode" name="zipcode" placeholder="우편번호" readonly>
          <button type="button" onclick="findPostcode()">우편번호 찾기</button><br>
          <input type="text" id="address" name="address" placeholder="기본 주소" readonly><br>
          <input type="text" id="address_detail" name="address_detail" placeholder="상세 주소 입력">
        </td>
      </tr>

      <tr><td>생년월일</td><td colspan="2"><input type="text" name="birth" placeholder="YYYY-MM-DD"></td></tr>
      <tr><td>전화번호</td><td colspan="2"><input type="text" name="phone_number"></td></tr>
      <tr><td>이메일</td><td colspan="2"><input type="email" name="email"></td></tr>
    </table>

    <div class="btn-row">
      <input type="submit" value="가입">
      <button type="button" onclick="history.back()">취소</button>
    </div>
  </form>
</div>
</body>
</html>
