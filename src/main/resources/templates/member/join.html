<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>íšŒì›ê°€ì…</title>
<link rel="stylesheet" th:href="@{/css/join.css}">
<link rel="stylesheet" th:href="@{/css/header.css}">

<!-- ğŸ§© ì¹´ì¹´ì˜¤(ë‹¤ìŒ) ìš°í¸ë²ˆí˜¸ API ë¶ˆëŸ¬ì˜¤ê¸° -->
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
let idChecked = false;

// ğŸ”¹ ì•„ì´ë”” ì¤‘ë³µì²´í¬
function dupl_check() {
  const idInput = document.querySelector("input[name='id']");
  const idValue = idInput.value.trim();

  if (!idValue) {
    alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    idChecked = false;
    return;
  }

  fetch(`/dupl_check?id=${encodeURIComponent(idValue)}`)
    .then(response => response.text())
    .then(result => {
      if (result === "true") {
        alert("ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.");
        idChecked = true;
      } else {
        alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.");
        idChecked = false;
      }
    })
    .catch(err => {
      alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      console.error(err);
      idChecked = false;
    });
}

function idChanged() {
  idChecked = false;
}

// ğŸ”¹ íšŒì›ê°€ì… í¼ ì œì¶œ ì „ ê²€ì‚¬
function checkFormSubmit(event) {
  if (!idChecked) {
    alert("ì¤‘ë³µì²´í¬ë¥¼ í•˜ê³  ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
    event.preventDefault();
    return;
  }

  const requiredFields = ["id", "pw", "nickname", "name", "zipcode", "address", "birth", "phone_number", "email"];
  for (let fieldName of requiredFields) {
    const field = document.querySelector(`input[name='${fieldName}']`);
    if (!field || !field.value.trim()) {
      alert(`${fieldName}ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
      field.focus();
      event.preventDefault();
      return;
    }
  }
}

// ğŸ”¹ ì¹´ì¹´ì˜¤ ì£¼ì†Œ API
function findPostcode() {
  new daum.Postcode({
    oncomplete: function(data) {
      document.getElementById('zipcode').value = data.zonecode; // ìš°í¸ë²ˆí˜¸
      document.getElementById('address').value = data.address;   // ê¸°ë³¸ ì£¼ì†Œ
      document.getElementById('address_detail').focus();         // ìƒì„¸ì£¼ì†Œë¡œ í¬ì»¤ìŠ¤ ì´ë™
    }
  }).open();
}
</script>
</head>

<body>
<div th:replace="layout/header :: siteHeader"></div>

<div class="page-content">
  <h2>íšŒì›ê°€ì…</h2>

  <form action="/join" method="post" onsubmit="checkFormSubmit(event)">
    <table>
      <tr>
        <td>ì•„ì´ë””</td>
        <td>
          <input type="text" name="id" oninput="idChanged()">
        </td>
        <td>
          <button type="button" onclick="dupl_check()">ì¤‘ë³µì²´í¬</button>
        </td>
      </tr>
      <tr><td>ë¹„ë°€ë²ˆí˜¸</td><td colspan="2"><input type="password" name="pw"></td></tr>
      <tr><td>ë‹‰ë„¤ì„</td><td colspan="2"><input type="text" name="nickname"></td></tr>
      <tr><td>ì´ë¦„</td><td colspan="2"><input type="text" name="name"></td></tr>
      <tr>
        <td>ì£¼ì†Œ</td>
        <td colspan="2">
          <input type="text" id="zipcode" name="zipcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
          <button type="button" onclick="findPostcode()">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button><br>
          <input type="text" id="address" name="address" placeholder="ê¸°ë³¸ ì£¼ì†Œ" readonly><br>
          <input type="text" id="address_detail" name="address_detail" placeholder="ìƒì„¸ ì£¼ì†Œ ì…ë ¥">
        </td>
      </tr>

      <tr><td>ìƒë…„ì›”ì¼</td><td colspan="2"><input type="text" name="birth" placeholder="YYYY-MM-DD"></td></tr>
      <tr><td>ì „í™”ë²ˆí˜¸</td><td colspan="2"><input type="text" name="phone_number"></td></tr>
      <tr><td>ì´ë©”ì¼</td><td colspan="2"><input type="email" name="email"></td></tr>
    </table>

    <div class="btn-row">
      <input type="submit" value="ê°€ì…">
      <button type="button" onclick="history.back()">ì·¨ì†Œ</button>
    </div>
  </form>
</div>
</body>
</html>
