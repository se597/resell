<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>상품 수정</title>
    <!-- 공통 헤더 CSS -->
	<link rel="stylesheet" th:href="@{/css/header.css}">
	<!-- 수정폼 CSS -->
    <link rel="stylesheet" th:href="@{/css/form.css}">
</head>
<body>
<div th:replace="layout/header :: siteHeader"></div>
<div class="page-content">
    <h2>상품 수정</h2>

    <form th:action="@{/content/update}" method="post" enctype="multipart/form-data">
        <!-- 상품번호 (숨김) -->
        <input type="hidden" name="pr_no" th:value="${item.pr_no}">

        <div class="form-line">
            <label>상품명</label>
            <input type="text" name="product_name" 
                   th:value="${item.product_name}" 
                   placeholder="상품명을 입력하세요" required>
        </div>

        <div class="form-line">
            <label>가격</label>
            <input type="number" name="price" 
                   th:value="${item.price}" 
                   placeholder="가격을 입력하세요" required>
        </div>

        <div class="form-line">
            <label>제목</label>
            <input type="text" name="title" 
                   th:value="${item.title}" 
                   placeholder="제목을 입력하세요" required>
        </div>

        <div class="form-line">
            <label>작성자</label>
            <input type="text" name="writer" 
                   th:value="${item.writer}" readonly>
        </div>

        <div class="form-line">
            <label>내용</label>
            <textarea name="content" rows="6" 
                      placeholder="상품 설명을 입력하세요"
                      th:text="${item.content}"></textarea>
        </div>

        <!-- 파일 1 -->
		<div class="form-line">
    		<label>파일 1</label>
    		<input type="file" name="upload1">
    		<span th:if="${item?.file1}">
		        <small>
            		현재 파일:
            		<a th:href="@{'/upload/' + ${item.file1}}" th:text="${item.file1}" target="_blank"></a>
        		</small>
        		<label><input type="checkbox" name="deleteFile1"> 삭제</label>
    		</span>
    		<input type="hidden" name="oldFile1" th:value="${item.file1}">
		</div>

        <!-- 파일 2 -->
 		<div class="form-line">
    		<label>파일 2</label>
    		<input type="file" name="upload2">
    		<span th:if="${item?.file2}">
		        <small>
            		현재 파일:
            		<a th:href="@{'/upload/' + ${item.file2}}" th:text="${item.file2}" target="_blank"></a>
        		</small>
        		<label><input type="checkbox" name="deleteFile2"> 삭제</label>
    		</span>
    		<input type="hidden" name="oldFile2" th:value="${item.file2}">
		</div>

        <!-- 파일 3 -->
		<div class="form-line">
    		<label>파일 3</label>
    		<input type="file" name="upload3">
    		<span th:if="${item?.file3}">
		        <small>
            		현재 파일:
            		<a th:href="@{'/upload/' + ${item.file3}}" th:text="${item.file3}" target="_blank"></a>
        		</small>
        		<label><input type="checkbox" name="deleteFile3"> 삭제</label>
    		</span>
    		<input type="hidden" name="oldFile3" th:value="${item.file3}">
		</div>

        <!-- 카테고리 -->
        <div class="form-line">
            <label>카테고리 1</label>
            <select id="cat1" name="cat1_id" onchange="cat2_activate()" required>
				<option>-- 선택 --</option>
            </select>
        </div>

        <div class="form-line">
            <label>카테고리 2</label>
            <select id="cat2" name="cat2_id" onchange="cat3_activate()" required>
                <option value="">-- 선택 --</option>
            </select>
        </div>

        <div class="form-line">
            <label>카테고리 3</label>
            <select id="cat3" name="cat3_id" required>
                <option value="">-- 선택 --</option>
            </select>
        </div>

        <div class="btn-row">
            <button type="submit" class="btn login-btn">수정 완료</button>
            <button type="button" class="btn join-btn" 
                    th:onclick="|location.href='/detail/${item.pr_no}'|">돌아가기</button>
        </div>
    </form>
</div>
<script  th:inline="javascript">
	const selectedCat1 = [[${item.cat1_id}]];
	const selectedCat2 = [[${item.cat2_id}]];
	const selectedCat3 = [[${item.cat3_id}]];
	document.addEventListener('DOMContentLoaded', async () => {
		  await loadCat1(selectedCat1);
		  await loadCat2(selectedCat1, selectedCat2);
		  await loadCat3(selectedCat2, selectedCat3);
		});

	
	
	async function loadCat1(selectedId) {
		const res = await fetch('/content/api/category', { method: 'POST' });
		const list = await res.json();

		const select = document.getElementById('cat1');
		select.innerHTML = '';

		const defaultOption = document.createElement('option');
		defaultOption.value = '';
		defaultOption.textContent = '-- 선택 --';
		select.appendChild(defaultOption);

		list.forEach(cat => {
			const opt = document.createElement('option');
	    	opt.value = cat.cat1_id;
		    opt.textContent = cat.cat1_name;
		    if (cat.cat1_id == selectedId) opt.selected = true;
	    	select.appendChild(opt);
		});
	}

	async function loadCat2(parentId, selectedId) {
	  const data = new URLSearchParams();
	  data.append('cat1', parentId);
	  const res = await fetch('/content/api/category2', {
	    method: 'POST',
	    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
	    body: data
	  });
	  const list = await res.json();

	  const select = document.getElementById('cat2');
	  select.innerHTML = '';
	  const defaultOption = document.createElement('option');
	  defaultOption.value = '';
	  defaultOption.textContent = '-- 선택 --';
	  select.appendChild(defaultOption);

	  list.forEach(cat => {
	    const opt = document.createElement('option');
	    opt.value = cat.cat2_id;
	    opt.textContent = cat.cat2_name;
	    if (cat.cat2_id == selectedId) opt.selected = true;
	    select.appendChild(opt);
	  });
	}

	async function loadCat3(parentId, selectedId) {
	  const data = new URLSearchParams();
	  data.append('cat2', parentId);
	  const res = await fetch('/content/api/category3', {
	    method: 'POST',
	    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
	    body: data
	  });
	  const list = await res.json();

	  const select = document.getElementById('cat3');
	  select.innerHTML = '';
	  const defaultOption = document.createElement('option');
	  defaultOption.value = '';
	  defaultOption.textContent = '-- 선택 --';
	  select.appendChild(defaultOption);

	  list.forEach(cat => {
	    const opt = document.createElement('option');
	    opt.value = cat.cat3_id;
	    opt.textContent = cat.cat3_name;
	    if (cat.cat3_id == selectedId) opt.selected = true;
	    select.appendChild(opt);
	  });
	}


	function cat2_activate(){
		const data = new URLSearchParams();
	    data.append('cat1', document.getElementById('cat1').value);
		fetch('/content/api/category2', {
			method: 'POST',
			headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
			body: data
		})
		.then(res => res.json())
		.then(list => {
			const select = document.getElementById('cat2');
			const select2 = document.getElementById('cat3');
		    select.disabled = false;
		    select.innerHTML = '';
		    select2.disabled = true;
		    select2.innerHTML = '';
		    const defaultoption1 = document.createElement('option');
		    const defaultoption2 = document.createElement('option');
		    defaultoption1.value = '';
		    defaultoption2.value = '';
		    defaultoption1.textContent = '-- 선택 --';
		    defaultoption2.textContent = '-- 선택 --';
		    select.appendChild(defaultoption1);
		    select2.appendChild(defaultoption2);
		    list.forEach(cat => {
		    	const opt = document.createElement('option');
				opt.value = cat.cat2_id;
				opt.textContent = cat.cat2_name;
				select.appendChild(opt);
			});
		})
		.catch(err => console.error('카테고리 로드 실패', err));
	}
	
	function cat3_activate(){
		const data = new URLSearchParams();
	    data.append('cat2', document.getElementById('cat2').value);
		fetch('/content/api/category3', {
			method: 'POST',
			headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
			body: data
		})
		.then(res => res.json())
		.then(list => {
			const select = document.getElementById('cat3');
		    select.disabled = false;
		    select.innerHTML = '';
		    const defaultoption = document.createElement('option');
		    defaultoption.value = '';
		    defaultoption.textContent = '-- 선택 --';
		    select.appendChild(defaultoption);
		    list.forEach(cat => {
		    	const opt = document.createElement('option');
				opt.value = cat.cat3_id;
				opt.textContent = cat.cat3_name;
				select.appendChild(opt);
			});
		})
		.catch(err => console.error('카테고리 로드 실패', err));
	}
</script>
</body>
</html>
